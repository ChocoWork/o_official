## タイトル
- `カート (Cart)`

基づく仕様ファイル: docs/ECSiteSpec.md
推奨タスクID: [DOC-03]

## 概要
- 永続カート（ログイン不要で Cookie ベース）を提供し、数量・バリアント変更、クーポン適用、カート表示を担う機能群。

## 範囲 (In / Out)
- 含むもの: カートの永続化（Cookie）、カート編集（数量・バリアント）、クーポン適用、カートのサマリ表示。
- 含まないもの: 複数配送先対応（不要）

## 機能要件
1. カート永続化: ログイン有無にかかわらず Cookie でカートを保持。
2. カート編集: 数量変更、バリアント切替、アイテム削除。
3. クーポン/プロモーション: 1コード1回利用、併用不可のルール適用。
4. カートサマリ: 商品小計、クーポン割引、推定送料、税（表示は参考）を表示。

## 非機能要件
- レスポンス目標: カート API 95% < 150ms。
- セキュリティ: 不正なクーポン利用を防止するサーバ側検証。

## API / インターフェース
- GET `/api/cart` - カート取得
- POST `/api/cart/add` - アイテム追加 { sku_id, qty }
- POST `/api/cart/update` - 数量/バリアント更新
- POST `/api/cart/apply-coupon` - クーポン適用

## データモデル（概要）
```sql
carts (
  id uuid PRIMARY KEY,
  session_id text,
  items jsonb,
  updated_at timestamptz
)
```

## バリデーションルール
- qty: 整数 >=1、在庫チェックはサーバ側で行う。

## テストケース（受け入れ基準）
- 正常系: ゲストが商品を追加→数量変更→チェックアウトに進める。
- 異常系: 在庫より多い数量を追加しようとするとエラー。

## マイグレーション影響
- カート永続化に DB を利用する場合は carts テーブル追加の検討。

## セキュリティ / プライバシー考慮
- クーポン適用はサーバ側で検証。Cookie は HttpOnly かつ署名付きで改竄防止。

## 実装ノート
- フロント: Cart コンポーネントは差分更新（optimistic UI）を行うが、在庫整合はサーバ確認を優先。
- 永続化は短期: 30 日などの TTL 設定を推奨。

## 関連ドキュメント
- docs/ECSiteSpec.md（カート・チェックアウト セクション）

## 担当 / 依存
- 担当: Frontend（Cart UI）, Backend（Cart API、クーポン検証）
- 依存: 在庫管理（SKU 在庫情報）

## 受け入れ基準（まとめ）
- ゲスト・会員ともにカートにアイテムを保持でき、クーポン適用ルールに従って合計が計算されること。

## チケット分割例
- TASK-1: Cart API 実装（add/update/get）
- TASK-2: Cart UI 実装
- TASK-3: クーポン適用ロジック実装
