## タイトル
- `管理画面 (Admin)`

基づく仕様ファイル: docs/ECSiteSpec.md
推奨タスクID: [DOC-05]

## 概要
- 管理画面（Admin）は商品登録・在庫管理・注文管理・プロモーション管理・レポート表示を担う。CSV バルクインポートやロール/アクセス管理（管理者、サポーター等）を含む。

## 範囲 (In / Out)
- 含むもの: 商品 CRUD、CSV インポート、在庫管理、注文ステータス管理、顧客検索、プロモーション管理、KPI ダッシュボード。
- 含まないもの: 外部 ERP/PIM の全面導入（要件発生時に別タスク）。

## 機能要件
1. 商品管理: 商品登録・編集・削除、CSV/バルクインポート（必須項目を設計）。
2. 在庫管理: SKU レベルの在庫編集、入出庫履歴閲覧。
3. 注文管理: 注文一覧、ステータス変更、返金・キャンセル処理。
4. 顧客管理: 顧客検索、セグメント表示。
5. プロモーション管理: クーポン作成、セール設定、バナー管理。
6. KPI ダッシュボード: 売上、注文、流入、AOV、在庫指標等の表示（docs に定義された指標を反映）。

## 非機能要件
- レポートはクエリ負荷対策のため集計テーブル/バッチ更新を検討。管理画面は権限設定で保護。

## 権限設計 / RLS（追加）
- RBAC: 管理画面は少なくとも `admin` と `supporter` のロールを実装し、操作毎に権限を明確化する（例: 商品編集は `admin` のみ、発送ステータス更新は `supporter` も可）。
- RLS: Supabase/Postgres の RLS を用いてテーブルレベルでアクセス制御を実施する。サンプルポリシーをドキュメント化すること。
- 監査ログ: すべての管理操作（作成/更新/削除/権限変更）は監査ログに記録し改ざん防止を行う（不可変ログ）。
- 管理画面のセキュリティ: 管理者アカウントは 2FA を必須にし、ログイン試行に対する通知を実装する。


## API / インターフェース
- 管理 API はすべて認証 + RBAC を要求。
- 代表的エンドポイント:
  - POST `/api/admin/items/import` (CSV)
  - GET `/api/admin/orders`
  - POST `/api/admin/orders/:id/status`

## データモデル（概要）
- 既存の products/skus/orders テーブルを利用。インポート用ログ/ジョブテーブルを設計。

## バリデーションルール
- CSV インポート時は必須カラムチェック、型チェック、重複 SKU 検出を行う。

## テストケース（受け入れ基準）
- 正常系: CSV インポートで商品の一括登録が成功し、在庫が反映される。
- 異常系: 不整合データがある場合はエラー一覧を返し、部分インポートは明示的に扱う。

## マイグレーション影響
- インポート用ジョブメタデータや履歴テーブルが必要な場合は DB 変更を計画。

## セキュリティ / プライバシー考慮
- 管理画面は強力な認証・2FA を推奨。RBAC で操作制限。

## 実装ノート
- KPI ダッシュボードは初期はサマリ表示に留め、重い集計はバッチ処理で更新する。
- CSV フォーマット仕様はドキュメント化し、サンプルファイルを提供すること。

## 関連ドキュメント
- docs/ECSiteSpec.md（管理画面、KPI ダッシュボード）

## 担当 / 依存
- 担当: Backend（CSV 処理、API）, Frontend（Admin UI）
- 依存: 管理者認証、ストレージ、ジョブキュー

## 受け入れ基準（まとめ）
- 管理画面で商品登録・在庫更新・注文ステータス変更が行え、CSV インポートによる一括登録が検証可能であること。

## チケット分割例
- TASK-1: CSV インポート API + ジョブ実装
- TASK-2: 商品管理 UI
- TASK-3: KPI ダッシュボード基盤実装

## 管理者向けセキュリティ運用仕様（必須追記）

### 管理者オンボーディング手順
1. 依頼発生: 管理者アカウント発行はチケット経由で申請。
2. 身元確認: 申請者の所属・メールを確認し、2 要素認証（2FA）設定まで担当者がガイドする。
3. 最小権限付与: 初期は `supporter` 相当の限定権限を付与し、業務確認の後に `admin` 権限を付与する。
4. 初回ログイン: 初回ログイン時にパスワード変更と 2FA の有効化を必須化する。
5. ドキュメント配布: 管理操作の利用規約、ランブック、オンボーディングチェックリストを配布する。

### 2FA 有効化手順（管理者）
1. 管理画面で `Enable 2FA` を選択。
2. サーバが TOTP シークレットを発行し、QR コードを表示。
3. 管理者は Authenticator（Google Authenticator 等）で QR をスキャンし、初回コードを入力して検証。
4. 端末名を登録し、リカバリコード（ワンタイム）を発行・保存することを義務付ける。
5. 2FA を強制: ロールが `admin` の全ユーザは 2FA を必須とする。

### 監査ログスキーマ（保存期間・フォーマット）
- フォーマット: JSON Lines（構造化ログ）を採用。改ざん防止のため WORM ストレージまたは署名を併用する。
- スキーマ（例）:
```json
{
  "id": "uuid",
  "timestamp": "2025-01-01T12:00:00Z",
  "actor_id": "uuid",
  "actor_email": "admin@example.com",
  "action": "items.update",
  "resource": "items",
  "resource_id": "uuid",
  "ip": "203.0.113.1",
  "user_agent": "Mozilla/5.0...",
  "outcome": "success|failure",
  "metadata": {"diff": {"price": {"from":1000, "to":1200}}}
}
```
- 保存期間:
  - ホット（即時検索/障害調査用）: 1 年
  - コールド（アーカイブ）: 7 年（法規制/会計要件に応じて延長可能）
  - ログはローテーションで圧縮・アーカイブし、アクセス権限を厳格に管理する。

### 監査ログ運用
- 監査ログは変更不可なストレージに保存し、整合性検証（ハッシュ）を定期実行する。
- 重要操作（権限変更、払い戻し、高額割引）は即時アラート対象とし、オンコールへ通知する。

