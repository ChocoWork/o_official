## タイトル
- `非機能要件 (Non-functional)`

基づく仕様ファイル: docs/ECSiteSpec.md
推奨タスクID: [DOC-06]

## 概要
- 本ファイルはパフォーマンス、スケーラビリティ、可用性、セキュリティ、国際化、アクセシビリティ、SEO などの非機能要件を実装指針レベルでまとめる。

## 範囲 (In / Out)
- 含むもの: パフォーマンス目標、SLO/SLA、スケーラビリティ方針、セキュリティ要件、バックアップ/DR、国際化要件、アクセシビリティ目標、SEO 要件
- 含まないもの: 個別サービスの細かいインフラ構築手順（別ドキュメント）

## 非機能要件（詳細）
- パフォーマンス: LCP < 2.5s（モバイル重点）、95/99パーセンタイル閾値をサービス別に設定。
- レイテンシ: API 応答 95% < 200ms（商品/認証/カート等）
- スケーラビリティ: ステートレス設計、オートスケール方針（CPU/RPS/キュー長に基づく）
- 可用性: サイト稼働率 99.9%（SLO をサービス別に定義）
- バックアップ/DR: RPO = 1h, RTO = 2h、定期的な復旧検証
- セキュリティ: TLS/HSTS、入力検証、CSRF/XSS 対策、強力なパスワードポリシー、シークレットは Secrets Manager 管理
- コンフォーマンス: PCI（決済はトークン化）、GDPR/個人情報対応（削除/エクスポート）
- アクセシビリティ: WCAG 2.1 AA を目安。主要テンプレートは自動/手動チェックを必須化
- SEO: 構造化データ（Schema.org）、SSR/プリレンダ、適切な meta / canonical
- 国際化: 日付/通貨ローカライズ、翻訳管理ワークフロー、多通貨表示（参照）

## 受け入れ基準
- パフォーマンスベンチマーク（95パーセンタイル）を満たすこと
- SLO に基づくアラート設定が存在すること
- 主要テンプレートが WCAG 自動チェックをパスすること

## 実装ノート
- フロント最適化: `next/image`、Critical CSS、ISR/SSG の利用方針を明記
- キャッシュ: CDN TTL と API の Cache-Control 設計
- モニタリング: RUM + サーバメトリクス（OpenTelemetry）を組み合わせる

## チケット分割例
- TASK-1: パフォーマンスベンチマークと監視ダッシュボード設定
- TASK-2: カード・画像の最適化実装（next/image + CDN）
- TASK-3: WCAG 自動チェック導入

## 監視・可観測性（追記）
- OpenTelemetry による分散トレースの導入を必須化する。各リクエストに `trace-id` を付与し、ログ/メトリクスと結合する。
- メトリクス標準: P95/P99 レイテンシ、エラー率、スループット、決済失敗率、カート放棄率。
- SLO 例: API レイヤー P95 < 200ms, P99 < 500ms。ページ表示 P95 < 2.5s。アラート: エラー率 > 1% または P99 超過が 5 分継続。

## テスト / 品質ゲート（追記）
- 必須 E2E: 購入フロー（ゲスト/会員）、決済 Webhook 処理、管理画面の主要パスを CI に組み込むこと。
- 契約テスト: 外部連携（Stripe, 配送 API 等）は契約テストを用意し、ステージングで自動検証する。
- 負荷試験: リリース前に主要 API のスモーク負荷試験を実施し、ターゲット RPS を満たすか確認する（例: スモーク 100 RPS、ステージングでのより大きな負荷試験は別途計画）。

### 必須メトリクス一覧とアラート閾値（運用基準）
- レイテンシ（API）: P95 < 200ms（警告）, P99 < 1s（重大）
- レイテンシ（ページ表示/LCP）: P95 < 2.5s, P99 < 5s
- エラー率（全 API 呼び出し）: 通常 < 1%（警告閾値）、> 5% は重大インシデント
- 決済失敗率（支払い試行に対する失敗）: 通常 < 2%（警告閾値）、> 5% は即時調査
- 決済 Webhook 処理失敗率（ワーカー内）: > 1%（持続 1h で警告）
- キュー長（バックグラウンドジョブ）: キュー長が通常の 2 倍を超えたら警告
- カート放棄率: 日次変化が +10% を超えたら要調査

アラートルールの例:
- API エラー率 > 1% が 5 分継続 → PagerDuty トリアージ（警告）
- P99 API レイテンシ > 1s が 2 分継続 → PagerDuty（重大）
- 決済失敗率 > 2% が 1 時間持続 → Slack 通知 + オンコールアラート

### トレース命名規則
- 命名フォーマット: `{component}.{resource}.{operation}`
	- 例: `api.items.getList`, `worker.checkout.processPayment`, `cron.inventory.reconcile`
- ルール: 小文字ドット区切り、HTTP ハンドラは `api.<resource>.<method>`、バックグラウンド処理は `worker.<domain>.<action>` を使用する。

### CI の必須テスト一覧と合格基準
- Unit tests: すべてのモジュールで実行、カバレッジ目標 >= 80%（サービス重要部分は 90%）
- Integration tests: DB/API 結合の主要ケースをカバー。すべて成功。
- Contract tests: 外部連携（Stripe/配送/メール）の契約テストはすべてパス。
- E2E tests: 主要ユーザージャーニー（購入/Webhook/管理画面）を実行し、緑であること。
- Security scans (SAST/Dependency scan): クリティカル/ハイの脆弱性が新規でないこと。新規ハイはブロック。

合格基準:
- PR マージ: Lint + Unit + Integration + Contract の必須チェックがすべて成功していること。E2E はマージ前またはマージ直後のステージングで成功していることを推奨。
- セキュリティ: クリティカル問題なし、ハイは審査チケットで解決計画があること。


