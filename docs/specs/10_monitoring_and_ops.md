## タイトル
- `監視と運用 (Monitoring & Ops)`

基づく仕様ファイル: docs/ECSiteSpec.md
推奨タスクID: [DOC-10]

## 概要
- 監視、ロギング、CI/CD、バックアップ、ランブック等の運用要件を整理する。運用フローと定期チェックを定義する。

## 範囲 (In / Out)
- 含むもの: モニタリング指標、アラートポリシー、ログ保存方針、バックアップ/DR、CI/CD パイプライン、運用チェックリスト
- 含まないもの: ベンダー別の完全設定マニュアル

## 監視 & メトリクス
- 主要メトリクス: レイテンシ、エラー率、決済失敗率、注文処理時間、キュー長
- RUM + サーバメトリクス + トレース（OpenTelemetry）を組み合わせる

## テスト戦略（追加）
- E2E 要件: CI に組み込む必須 E2E テストを定義する。優先度高: 購入フロー（ゲスト/会員）、Webhook 完結フロー、管理画面主要操作。
- 負荷試験: 本番想定のピークに近い条件で定期的に負荷試験を実施し、スケールポリシー（CPU/RPS/キュー閾値）を検証する。初期目標例: 95% の主要 API が P95 閾値内で 100 RPS を処理できること。

## 品質ゲートと自動化（追加）
- CI の品質ゲート: Lint → Unit → Integration → Contract → E2E の順で自動実行。PR マージはすべての必須チェック通過を条件とする。
- 可観測性自動チェック: デプロイ後に基本的なメトリクス（エラー率・レイテンシ）のスモーク確認を自動で実行し、閾値超過ならロールバックをトリガーできるようにする。


## ログ & 保管
- 構造化ログ（JSON）、監査ログの保管（改ざん防止）
- 保存期間: 高解像度ログ 30 日、集計ログ 1 年

## アラート & エスカレーション
- SLO に基づくアラート。夜間/休日の担当者エスカレーションを定義

## CI/CD
- パイプライン: Lint → Unit → Integration → E2E（ステージング）→ Canary/Blue-Green デプロイ
- 自動ロールバック条件を設定（エラー率閾値等）

## バックアップ / DR
- DB スナップショット、オブジェクトストレージのバージョニング、定期リストアテスト

## 運用チェックリスト
- 日次/週次/月次のチェック項目を明記（例: 未処理注文確認、バックアップ検証、脆弱性スキャン結果）

## ランブック & インシデント対応
- 主要インシデント別の手順（検知 → 影響範囲特定 → ロールバック/フェイルオーバー → 通知 → ポストモーテム）

## チケット分割例
- TASK-1: 監視ダッシュボード基盤構築（RUM + APM）
- TASK-2: CI/CD パイプライン整備
- TASK-3: ランブック作成とオンコール体制確立

### 必須メトリクスと具体的アラート閾値（追記）
- API レイテンシ:
	- P95 < 200ms（警告閾値）, P99 < 1s（重大閾値）
- ページ表示:
	- LCP P95 < 2.5s
- エラー率:
	- 通常 < 1%（警告）, > 5%（重大）
- 決済失敗率:
	- 通常 < 2%（警告）, > 5%（即時調査）
- 決済 Webhook 処理失敗率:
	- > 1% が 1 時間継続で警告
- キュー遅延 / キュー長:
	- 通常値の 2 倍超で警告

アラート運用例:
- しきい値を超えたら 1st レベルは Slack 通知、継続 or 重大閾値超過で PagerDuty をトリガー。

### トレース命名規則（再掲）
- フォーマット: `{component}.{resource}.{operation}` 例: `api.items.getItem`, `worker.order.processPayment`。

### CI の必須テストリスト（追記）
- Unit Tests: 全体の品質ゲート。カバレッジ ≥ 80%（重要モジュールは 90%）。
- Integration Tests: DB/外部サービス接続を検証。すべて成功。
- Contract Tests: 外部連携の契約互換性を検証（Stripe, 配送 API など）。
- E2E Tests: 主要シナリオ（購入フロー、Webhook 完結フロー、管理画面主要操作）。
- Security Scans: 依存関係スキャン、SAST。クリティカルはブロック、ハイはチケット化。

合格基準:
- PR マージには Lint→Unit→Integration→Contract の合格が必須。E2E はステージングでの成功を要求。

