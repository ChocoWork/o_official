## タイトル
- `検索・フィルタ (Search & Filters)`

基づく仕様ファイル: docs/ECSiteSpec.md
推奨タスクID: [DOC-07]

## 概要
- 検索・フィルタ機能は UX の要であり、フルテキスト検索、属性フィルタ、ソート、URL による状態共有を持つ。

## 範囲 (In / Out)
- 含むもの: フルテキスト検索、サジェスト、属性フィルタ、ソート、URL のシェア可能性、フィルタ状態の永続化
- 含まないもの: 高度な ML ベースのパーソナライズ（将来導入）

## 機能要件
1. フルテキスト検索（必須）: スペルミス補正、部分一致、サジェスト
2. 属性フィルタ: サイズ、カラー、価格、カテゴリ、在庫有無
3. ソート: 人気、新着、価格昇順/降順
4. URL 共有: フィルタ状態と検索クエリを URL に反映
5. サジェスト: クエリ補完と商品/カテゴリ提案

## 非機能要件
- 検索応答性: 95% < 200ms を目標
- 一貫性: 検索結果の整合性（在庫情報はリアルタイム不要と定義）

## インデックス整合性（追加）
- DB を Source of Truth と定義し、検索インデックスは非同期で更新する設計を明記する。
- 注文フローにおける在庫チェックは必ず DB 側で行い、検索結果の在庫情報は参考表示とする。
- インデックス更新遅延時の UX: 在庫が不一致だった場合は注文時にユーザへ明示的にエラー/案内を行う。


## 実装候補
- 無料/簡易: Supabase のフルテキスト検索
- 高性能: Meilisearch / Algolia（必要に応じてスケールアップ）

## 在庫表示と予約に関する整合性（追記）
- 検索結果に表示する在庫情報は DB を Source of Truth とするが、インデックスは非同期更新のため表示は参考値とする。
- 注文時の在庫確保は `02_items.md` に示した reservation フローで DB で検証すること。

### 夜次リコンシリエーション（運用手順）
1. 集計ジョブを実行し、検索インデックスの在庫値と DB の在庫値を照合する。
2. 差分リストを生成し、しきい値（例: 差分が在庫の 1% 超 or absolute 10 個超）を超える場合は自動修正候補としてマーク。
3. 自動修正前に最新注文ログと reservation ログを参照し、訂正が安全かを確認する。
4. 手動レビューが必要なケースはオペレータにタスクを作成し、完了後にインデックスを再構築する。


## API / インターフェース
- GET `/api/search?q=&filters=&sort=&page=` - 検索エンドポイント
- GET `/api/suggest?q=` - サジェストエンドポイント

## テストケース（受け入れ基準）
- 正常系: クエリで期待する商品が上位に現れる、フィルタを適用すると結果が限定される
- 異常系: 不正なクエリは 400 を返す（長すぎる文字列等）

## 実装ノート
- インデックスの更新ポリシー（同期 vs 非同期）を定義
- フロントはパラメータを URL に反映し、サーバ側はそのまま再利用可能にする

## チケット分割例
- TASK-1: Supabase で基本検索を実装
- TASK-2: サジェスト API とフロント UI 実装
- TASK-3: 性能評価と必要に応じた Meilisearch 検討
