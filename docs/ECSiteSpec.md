
# アパレルブランド ECサイト 要件定義

## 1. 概要

本書は、アパレルブランド向けのECサイトに求められる要件を整理したものです。顧客体験の向上、コンバージョン最大化、運用効率、ブランド表現を両立することを目標とします。

## 2. 目標

- ブランドアイデンティティを反映した商品体験を提供する。
- 購入導線（閲覧 -> カート -> チェックアウト）をシンプルかつ高速にする。
- モバイルファーストで高いUXを維持する。
- グローバル展開を見据えた多言語・多通貨対応。
- セキュリティと法令遵守（個人情報保護、税・返品対応）。

### 優先度（回答反映）
- 日本向けの多言語・多通貨対応: 高（最優先）
- 欧州対応: WANT（要望だがMUSTではない）
- その他の目標（ブランド表現、購入導線、モバイル、セキュリティ等）: 高

### セキュリティ／法令の扱い（回答反映）
- 決済に関する要件: PCIは必須（カード情報はトークン化などで準拠）
- プライバシー: GDPRは必須（EU向けデータ処理・削除フロー等の整備）
- 2FA: 実装は望ましいが必須ではない（できれば導入）

### KPI（提案）
- パフォーマンス
	- ページ表示時間（95パーセンタイル）: < 2.5s
	- LCP (モバイル): < 2.5s
- コンバージョン指標
	- コンバージョン率（購入/セッション）: ベースラインを計測して改善目標を設定
	- カート放棄率: 現状比で改善目標を設定
	- 平均注文額（AOV）: 追跡して増加を目指す
- 信頼性・運用
	- 決済成功率: 99% 以上（地域差を考慮）
	- サイト稼働率: 99.9%（SLA目安）
- 顧客維持
	- リピート購入率（LTV指標）: 指標設定と改善計画
	- NPS / CSAT: 定期計測

（KPIはローンチ前に現状値を計測して目標値を確定します）

## 3. ユーザー要件（ペルソナ）

- エンドカスタマー（User）: スマホ、PC、タブレットで商品を検索・閲覧・購入したい。
- サイト管理者（Admin）: CMSを用いた商品登録、在庫管理、Lookの掲載、Newsの更新、KPIや注文履歴（発送状態含む）の閲覧・管理を行いたい。
- 発送管理者（Supporter）: 提携先の発送担当者として、注文履歴から発送状態の更新を行いたい。

- 備考: 返品フローは想定に含め、管理画面・サポート画面で対応できるように設計する。

## 4. 機能要件

### 4.1 カタログ・商品ページ
- 商品一覧（カテゴリ、コレクション）表示

- 商品一覧（カテゴリ、コレクション）表示
- バリエーション対応（必須軸: サイズ、カラー、素材）
- SKU単位の在庫・価格管理
- 商品画像ギャラリー（ズーム、複数角度、動画対応、最大15枚、アスペクト比は後で決定）
- サイズ表・フィットガイド表示
- 商品説明・お手入れ方法（例: 上質なウールを使用したミニマルなコート。シンプルながら洗練されたデザインで、長く愛用していただける一着です。お手入れ: ドライクリーニング推奨）
- 素材・取り扱い説明・洗濯表示
- 関連商品・コーディネート提案
- 在庫切れ時の入荷通知（Eメール）
- 備考: 商品レビューは現フェーズでは不要（将来的に再検討可）。SMSによる入荷通知は不要。

### 4.2 検索・フィルタ
- 高速なフルテキスト検索（スペルミス補正、サジェスト）
- 属性による絞り込み（価格、サイズ、カラー、カテゴリ）
- ソート（人気順、新着、価格順）

### 回答反映（検索・フィルタ）
- フィルタ状態はURLで共有可能にする（はい）。
- 表示方式: モバイルは無限スクロール、デスクトップはページネーション（売上最大化を狙った混合アプローチ）を推奨。
- 検索バックエンド（無料で実現する選択肢）:  `supabase` のフルテキスト検索を推奨。
- 検索結果でのリアルタイム在庫表示は不要（複数販売チャネルで同一SKUを売らないため）。

### 4.3 カート・チェックアウト

- 永続カート（ログイン無しでもCookieで保持）
- カート内の数量変更・バリエーション変更
- クーポン・プロモーションコード適用（利用回数: 各コード1回まで、クーポンの併用は不可）
- ゲストチェックアウト: 必須（ゲスト購入が可能）
- 会員チェックアウト（アドレス帳、自動入力）
- 多通貨表示: 表示のみ（価格表示は多通貨で参考表示、決済通貨はデフォルト通貨に準拠）
- 配送方法選択: 国内宅配（国内配送を優先、国際配送はMUSTではない）
- 複数配送先対応: 不要（対応しない）
- 注文確認画面・注文完了メール
- 注文のマイページ表示（注文履歴、配送状況）

### 4.4 会員・認証
 - メール／パスワード認証: 必須
 - ソーシャルログイン: UI上のボタンは表示する（機能は後実装）
 - パスワードリセット: 必須（メールによる再発行フロー）
 - 2FA: 可能であれば導入（望ましいが必須ではない）
 - 顧客プロファイル（当面の必須項目）: メールアドレス、名前、フリガナ、住所、電話、購入履歴
 - ウィッシュリスト、保存済みアイテム

### 4.5 管理画面（Admin）
- 商品登録/編集（CSV/バルクインポート）
- CSVインポート必須項目: カテゴリ、商品名、商品説明、価格、色、サイズ、商品詳細
- 在庫管理（SKUレベル）、入出庫履歴
- 注文管理（ステータス変更、返金、キャンセル）
- 顧客管理（検索、セグメント）
- プロモーション管理（クーポン、セール、バナー）
- レポート（売上、在庫、コンバージョン、チャネル別）
- ロール/アクセス権管理（当面は管理者1名想定。注文管理をするサポーターという権限。その他はユーザーとする）

### KPIダッシュボード（Admin）
管理画面に表示するKPIは以下を含む（Shopifyを模した構成）:
- 売上 (Sales): 総売上、純売上、日/週/月別推移、チャネル別売上
- 注文 (Orders): 注文数、平均注文数、注文ステータス、注文あたりの処理時間
- コンバージョン率 (Conversion Rate): セッション→購入の転換率、チェックアウト進捗
- 流入・集客 (Traffic / Acquisition): セッション数、流入元別パフォーマンス（オーガニック、広告、SNS、メール）
- 平均注文額 (AOV): 一回の注文あたりの平均売上、シーズン比較
- 顧客指標 (Customers): 新規／リピーター比率、顧客生涯価値（LTV）、地域別分布
- 商品別パフォーマンス (Product Performance): 売れ筋、在庫回転率、バリアント別売上
- 在庫・フルフィルメント (Inventory & Fulfillment): 在庫残、欠品予測、出荷遅延状況
- マーケティング効果 (Marketing / Attribution): キャンペーン別ROI、割引コード別売上
- チェックアウト離脱 (Checkout & Abandonment): カート放棄率、回復状況
- 返品・返金 (Returns & Refunds): 返品率、返金額、返品理由の傾向
- 決済・手数料 (Payments): 支払い方法別比率、チャージバック・手数料コスト
- 財務レポート (Finances): 売上総利益、税金・送料・手数料の内訳
- リアルタイム表示 (Live View): 現在の訪問者、実行中の注文、リアルタイムトラフィック
- カスタムレポート & 分析: 指標カスタム、セグメント分析、SQLライクなクエリ対応の検討

### 4.6 マーケティング・UX機能
 - メールマーケティング連携（ニュースレター登録、自動化）: 不要
 - パーソナライズ（MVPで必須）: 商品レコメンド、セグメント別表示をMVPで導入する
 - ポップアップ（在庫警告、クーポン提示）: MVPでは不要／後で導入
 - カート離脱リカバリ（メール自動送信）: 後で導入。SMSは使用しない
 - ソーシャルシェアリング

### 4.7 決済・配送・税金
 - 決済ゲートウェイ統合: Stripe を採用（主要カード、Apple Pay、Google Pay 等のトークン化対応）
 - 決済のセキュリティ: カード情報は Stripe のトークン化に委託し、PCI 準拠を確保
 - 分割払い / 後払い: Stripe の提供機能に準拠（詳細は Stripe 設定に委ねる）
 - 税計算: 日本国内のみ対応（国内税計算・軽減税率等を優先実装。国際税対応は将来的に検討）
 - 配送業者API連携: 配送業務は外部業者に委託。API連携は実装可能なら導入するが優先度は低い（将来的な自動追跡対応を検討）

## 5. 非機能要件

### 5.1 パフォーマンス
- ファーストバイト短縮、LCP/CLS改善、ページロード高速化
- 99パーセンタイルでも応答時間を低く保つ（目標：ページ表示 < 2s）

### 5.2 スケーラビリティ
- ピーク時（プロモーション/セール）にスケール可能
- ステートレスアーキテクチャ（セッションは外部ストア）

 ### 5.3 可用性・運用
 - SLA目標: 99.9%（確定）
 - 自動復旧・監視・アラート（エラー率、レイテンシ、ジョブ失敗）

### 5.4 セキュリティ
- TLS必須、HSTS設定
- 決済情報はPCI準拠（トークン化）
- 入力検証とXSS/CSRF対策
- パスワードハッシュ化（Argon2/Bcrypt）
- 権限管理と監査ログ

### 5.5 SEO/スニペット
- 商品ページの構造化データ（Schema.org）対応
- SSR/プリレンダでクローラービリティ確保
- メタ情報、OGタグ、canonicalの適切な設定

### 5.6 国際化（i18n）と地域対応
- 多言語（翻訳管理）、多通貨、ローカライズされた配送オプション
- 日付・数字・通貨表現のローカライズ

### 5.7 アクセシビリティ
- WCAG 2.1 AA 準拠を目標にする
- キーボード操作、スクリーンリーダー対応、色彩コントラスト

以下に各非機能要件の詳細と受け入れ基準を示します。

### 5.8 パフォーマンス（詳細）
- 目標指標: LCP < 2.5s、FID < 100ms、CLS < 0.1（モバイルファースト）
- ページ種別ごとのベンチマーク: トップ/カテゴリ/商品/カート/checkout の90/95/99パーセンタイルを測定して閾値を設定
- フロントエンド最適化: 画像の遅延読み込み（lazy loading）、プレロード・プリフェッチの活用、Critical CSS抽出
- アセット配信: CDNを用いた静的アセット配信、HTTP/2またはHTTP/3の利用、Brotli/Gzip圧縮
- キャッシュ戦略: ISR/SSG/SSRの使い分け、エッジキャッシュ（CDN）TTLの設計、APIレスポンスのキャッシュ（Cache-Control）
 - 監視: RUM（Real User Monitoring）と合成監視（Synthetic）を組み合わせて実ユーザー体験を定量化。合成監視は5分間隔で実施する。

### 5.9 スケーラビリティ（詳細）
- 水平方向スケーリング: アプリケーションはステートレスにし、セッションはRedisやDynamoDB等に保存
- バッチ処理・非同期処理: 注文処理や在庫同期はキュー（RabbitMQ / SQS / Pub/Sub）で非同期化しリトライ/デッドレターを実装
- オートスケールの設計: トラフィックとジョブ負荷に基づくスケールポリシーの定義（CPU/RPS/キュー長）

### 5.10 可用性・運用（詳細）
- SLAとSLO: 目標稼働率とエラーバジェットを定義し、主要サービスごとのSLOを設定
- 冗長化設計: 複数AZ／リージョンでの冗長化、DBはリードレプリカとフェイルオーバー構成
 - バックアップ/復旧: RPO = 1時間、RTO = 2時間 を目標に定義し、定期リストア検証を実施
- 運用手順: インシデント対応ランブック、ポストモーテム文化、定期的なフェイルオーバーテスト

### 5.11 セキュリティ（詳細）
- ネットワーク/インフラ: VPC分離、最小権限のセキュリティグループ設計
- アプリケーション: 入力検証、パラメータ化クエリ、CSP（Content Security Policy）導入
- 認証・認可: 強力なパスワードポリシー、オプションでSAML/OAuth SSO、ロールベースアクセス制御（RBAC）
- シークレット管理: KMS/Secrets Managerで鍵・トークンを管理、ハードコーディング禁止
- データ保護: 保存データは必要に応じて暗号化（静止・転送中）、個人情報はマスキング
- 監査・ログ: 監査ログを保持し改ざん防止、セキュリティイベントのSIEM統合
 - テスト/評価: 自動化された脆弱性スキャンを月次で実行。ペネトレーションテストは4か月に1回（年3回相当）を実施する。

### 5.12 コンパイアンス・法令対応
- 決済: PCI DSS 準拠（可能ならカード情報はトークン化してプロバイダに委託）
- プライバシー: GDPR/CCPA等該当法準拠、データアクセス要求・消去フローの実装
- 記録保持: 法令に従ったログ・領収書の保管期間と取り扱いルール

### 5.13 SEO / インデックス（詳細）
- 技術SEO: URL設計、クローラー向けのrobots.txt、サイトマップ自動生成
 - 構造化データ: 商品、在庫、価格、BreadcrumbList のSchemaを出力
- パフォーマンス依存SEO: Core Web Vitals を改善する施策を優先

### 5.14 国際化・多言語対応（詳細）
- 言語/通貨ごとのコンテンツ戦略（地域別コンテンツ、価格差、配送条件の管理）
- 翻訳管理ワークフロー（Crowdin等の外部サービス連携）、翻訳のバージョン管理
- 税・配送ルール: 地域ごとの税計算と配送可否のルールエンジン

### 5.15 アクセシビリティ（詳細）
- 達成基準: WCAG 2.1 AA を最低ラインにし、主要テンプレートの自動・手動チェックを組み合わせる
- テスト: スクリーンリーダーとキーボードでのE2Eテスト、色覚多様性チェック
- 補助: altテキスト必須、フォームのラベル付与、フォーカス管理

### 5.16 ロギング・監視・アラート
- メトリクス: レイテンシ、エラー率、スループット、決済失敗率、カート放棄率などを可視化
- ログ: 構造化ログ（JSON）、トレーシング（分散トレーシング: OpenTelemetry）を実装
 - アラート: SLOに基づくアラートポリシー。通知先はSlack（運用通知）とし、オンコールは管理者のSlackアカウントで対応する
 - モニタリング保守: ログ保存期間を確定 — 高解像度ログ（詳細）を30日保存、低解像度ログ（集計/アーカイブ）を1年間保存する

### 5.17 バックアップ・DR（詳細）
- バックアップ頻度: DBは増分バックアップ（例: 毎1時間）、フルバックアップは日次
- メディア: ユーザーアップロードは冗長なオブジェクトストレージに保存（バージョニング有効）
- DR計画: 主要リージョン障害時のフェイルオーバー手順、定期的な復旧演習

### 5.18 運用コスト管理
- クラウドリソースのタグ付けとコストアロケーション
- スケール/予約インスタンスやスポット利用によるコスト最適化

### 5.19 受け入れ基準（サンプル）
- パフォーマンス: 95パーセンタイルのページ表示時間が2.5s未満であること
- 可用性: 月間稼働率が99.9%以上
- セキュリティ: 重大な脆弱性は発見後30日以内に修正
- アクセシビリティ: 主要テンプレートで自動チェックのエラーがゼロ


## 6. 統合要件

優先度順（高 → 低）での外部連携候補と推奨プロバイダ:

1. 決済（必須・最優先）: Stripe（確定）
2. DB / 認証（高）: Supabase (Postgres + Auth)
3. ホスティング / CDN（高）: Vercel（Next.js 向け）＋エッジCDN
	- CDN方針: 当面は無料枠を利用（例: Cloudflare Free / Vercel の無料エッジ） — 理由: 公開対象が日本のみのため、まずはコスト最適化
4. 検索 & パーソナライズ（MVP必須）: Supabase のフルテキスト検索を一次選択。必要に応じて Meilisearch を導入（パーソナライズはまずルールベース実装）
5. トランザクショナルメール: SendGrid または Mailgun（注文・通知用。マーケティングメールは現フェーズ不要）
6. 分析 / Google Analytics
7. 配送 / ロジスティクス（低優先）: 外部3PL に委託。API連携は将来の自動化用オプション（Shippo 等）
8. CRM / MA（低）: HubSpot 等を検討（顧客育成やメール配信の要件次第で導入）
9. PIM / ERP（要件次第）: SKU が増え運用が複雑化した段階で導入検討（例: Akeneo など）

備考: まずは最小構成でローンチし、運用で出た優先度に応じて Meilisearch、BI、PIM 等を順次導入する戦略を推奨します。

## 7. 運用・サポート要件

- バックアップ戦略（DB、メディア）
- リリース手順（ステージング→本番）、ロールバックプラン
- サポート体制（問い合わせ対応SLA、チャット/メール連携）
- 定期セキュリティ診断（脆弱性スキャン、依存性チェック）

## 8. 法務・コンプライアンス

- プライバシーポリシー、利用規約の準備
- 個人情報保護（データ保持ポリシー、同意管理）
- 返品/交換ポリシーと表示義務（国別要件に対応）
- 税務・輸出入規制の遵守（国際販売時）

## 9. モニタリング・テスト

- E2Eテスト（主要購入フロー）とCIパイプライン
- ログと指標（エラー率、注文処理時間、決済失敗率）
- A/Bテスト基盤（UI/プロモーション効果検証）

## 10. 優先度・マイルストーン（例）

- M1（MVP）: 商品一覧、商品詳細、カート、チェックアウト、決済連携、管理画面の基本
- M2: 会員機能、ウィッシュリスト、プロモーション管理
- M3: パーソナライズ、分析と最適化、多言語化・多通貨

## 11. 参考 / 意思決定ポイント

- ヘッドレス化（フロント独立） vs モノリシック：速度・開発運用コストのバランスを検討
- 商品データはPIMを導入するか否か（SKU数・チャネル数による）
- 決済・配送のサードパーティ選定は手数料とサポート地域を重視

## 13. デザイン要件（ブランド: Le Fil des Heures）

ブランドコンテキスト: 「Le Fil des Heures（ル フィル デ ザール）」は、ミニマル×モードの交差から生まれるタイムレスな日常着を提供するコンテンポラリーブランドです。価格帯はミドル〜ミドルハイ（約¥20,000〜¥80,000）。以下はブランド表現をEC上で一貫して担保するためのデザイン要件です。

### 13.1 タイポグラフィ
- ブランド見出しフォント: `Didot`（必須） — ロゴ・H1/H2の見出しに使用。縦線の繊細さと高コントラストを活かす（例: 小文字の `l`・`f` の縦線の表現）。
- 本文フォント（UI用）: 可読性の高いサンセリフ（例: `Inter`, `Noto Sans JP` など）を組み合わせ、言語切替時の日本語表示は `Noto Sans JP` を併用。
- フォント運用: 見出しはDidotのサブセットをプリロード、`font-display: swap` を設定し、FOUT対策を行う。
- スケール: レスポンシブ用のタイポグラフィスケールを定義（例: H1/H2/H3/Body/Small の rem 値）

### 13.2 カラーパレットと用途
- Primary: Absolute Black `#000000` — ロゴ、主要見出し、CTAのテキスト（高コントラスト）
- Secondary: Graphite Grey `#474747` — サブ見出し、補助テキスト、境界線
- Accent / Surface: Sand Beige `#d5d0c9` — 背景セクション（カード背景・ページの柔らかい切替）、アクセントの背景
- Neutral: Optical White `#ffffff` — 余白、カードのベース
- 使用ルール: 基本はモノクロ基調。Sand Beige はブランドの“温かみ”を出す箇所（商品背景、CTAのソフトバリエーション）に限定使用。

### 13.3 レイアウト・余白・グリッド
- グリッド: 12カラム（デスクトップ）、6カラム（タブレット）、2カラム（モバイル）を基準にコンテンツを配置。
- 余白: ブランドの「糸の繊細さ」を生かすために余白を広めに取り、要素間の呼吸を重視（例: セクション上下 56-80px、カード内パディング 24px 以上）。

### 13.4 UIコンポーネント（ブランド表現）
- ボタン:
	- Primary（購入系）: 黒背景（#000）＋白テキスト、角は中程度の丸み（4~8px）。
	- Secondary（ナビ等）: 白背景＋黒境界線＋黒テキスト、ホバーでGraphite Greyにフェード。
	- CTAs は視覚的に優先度が高く、配置はファーストビューやPDPで常時アクセス可能にする（フローティングCTAなど）。
- 入力/フォーム: シンプルなボーダー、プレースホルダはGraphite Grey、エラーメッセージは控えめな赤（ブランド外だが可読性重視）。
- カード: 白/Beige の二層表現。影は最小限にしてフラットで上品な質感を保つ。

### 13.5 画像・ビジュアル言語
- 写真: モノクロームに近いトーン、またはニュートラルな色味（サンドトーンの背景）で素材感と構築的ラインを強調。人物は自然光で非演出寄り、ポージングはシンプルで建設的ラインを見せる。
- ライティング: テクスチャ（糸目、ニットの表情）を見せるクローズアップを必ず含める。
- アスペクト比: 商品メインは4:5（縦長）推奨、ギャラリーに1:1／3:4も併用。

### 13.6 価格表示・商品情報
- 価格帯がミドル〜ミドルハイであることを明確にするため、価格表示は控えめで上品に。セール時は旧価格を小さく表示し、新価格は太字で強調。
- 素材・ケア情報はPDP内で視覚的に明確に（アイコンと短文）。

### 13.7 マイクロインタラクション・トーン
- アニメーションは控えめ（ease-in-out、150–250ms）、ホバーでの微かなリフトやフェードのみ使用。
- ローディング: プレースホルダはグラデーションよりも単色ベースのシンプルプレースホルダを採用し、高級感を損なわない。

### 13.8 ブランディング体験（梱包・メール等）
- 梱包: Absolute Black のロゴ（Didot）をOptical WhiteのボックスまたはSand Beigeの包装紙で表現。タグやインボイスは最小限の情報で上品に。
- 取扱説明/カード: 紙質感のある素材でブランドメッセージを短く添える（紙の質感はニュートラル）。
- メール: 件名は短くエレガントに。HTMLメールはブランドカラーとDidotの見出しを使用（本文はサンセリフで可読性確保）。

### 13.9 アクセシビリティと可読性（Didot特有の配慮）
- Didotは装飾的で見出し向け。本文にDidotを使うと可読性が落ちるため、本文はサンセリフを使用すること。
- コントラスト: 主要テキストは最低でもWCAG AA（または重要コンテンツはAAA）を満たす。黒テキスト（#000）対白背景は十分。
- 小さいサイズのテキストやUI要素にDidotを使う場合は字間（letter-spacing）をやや広げるなど調整を行う。

### 13.10 実装ガイド（簡易CSS変数例）
```
:root {
	--brand-black: #000000;
	--brand-graphite: #474747;
	--brand-sand: #d5d0c9;
	--brand-white: #ffffff;
	--font-heading: 'Didot', serif;
	--font-body: 'Inter', 'Noto Sans JP', sans-serif;
}
```

### 13.11 受け入れ基準（デザインQA）
- ホーム/商品/チェックアウトの主要テンプレートでブランドカラーが一貫して適用されていること。
- Didot を見出しに使用し、本文はサンセリフで読みやすいこと（自動チェックと目視確認）。
- 主要CTAのコントラスト比がWCAG基準を満たしていること（ツールでの数値検証）。

---

(注) デザイン要件を `doc/ECSiteSpec.md` に追記しました。必要ならこの内容をもとにコンポーネント設計（ボタン/カード/フォームのトークン化）を作成します。

## 14. 技術要件（コア & 推奨）

基本方針: フロントはReact/TypeScriptを中心に、サーバはNode.jsベースで、DBはSupabase(Postgres)を採用する前提で、開発生産性・運用性・スケーラビリティを担保する推奨技術を列挙します。

### 14.1 コアスタック（既定）
- フロントエンド: React + TypeScript
- フレームワーク: Next.js（既存ワークスペースに合わせ推奨）
- バックエンドランタイム/API: Node.js（Next API routes / serverless functions）
- DB/認証: Supabase (Postgres + Auth)

### 14.2 推奨ライブラリ・ツール（理由付き）
- データフェッチ/キャッシュ: `@tanstack/react-query` (データ同期・キャッシュ戦略が容易)
- フォーム: `react-hook-form` (パフォーマンス良好・バリデーション統合容易)
- スタイル: `Tailwind CSS` または CSS Modules（Atomicにまとめやすく、ブランドトークン反映が容易）
- 画像最適化: Next/Image（Next.js 利用時）または Cloudinary/imgix（CDN + 最適化）
- 検索: Meilisearch（セルフホスト/低レイテンシ）または Algolia（マネージド・高機能）
- 決済: Stripe（サブスクリプション/一括払い/Apple Pay等対応）
- バックグラウンドジョブ/キュー: BullMQ + Redis（ジョブの再試行・DEAD LETTER管理）
- キャッシュ/セッション: Redis（セッション、ロック、レート制御）
- E2Eテスト: Playwright（フル機能・クロスブラウザ）
- 単体/統合テスト: Jest + Testing Library / Vitest
- コンポーネントカタログ: Storybook（デザイン→実装の整合に有用）
- Lint/Format: ESLint + Prettier + TypeScript ESLint
- CI/CD: GitHub Actions（Lint/Tests/Build/Deploy自動化）
- モニタリング/エラートラッキング: Sentry（例）、OpenTelemetry（分散トレーシング）
- ログ/可観測性: 構造化ログ（JSON）→ SIEM or ELK/CloudWatch / Datadog
- オーサライズ（管理画面）: RBAC 実装、SSO(SAML/OAuth)は必要に応じて

### 14.3 インフラ・運用提案
- ホスティング: Vercel（Next.js最適）または AWS (ECS, Cloud Run)／GCP（Cloud Run）
- CDN: Cloudflare / Fastly（静的資産と画像のエッジ配信）
- Secrets管理: AWS Secrets Manager / GCP Secret Manager / HashiCorp Vault
- バックアップ: DBスナップショット + オブジェクトストレージのバージョニング（S3互換）

### 14.4 サードパーティ（運用用途）
- メール: SendGrid / Mailgun（トランザクション・マーケティング）
- 分析: GA4 + BigQuery（イベント収集→DWH）
- タックス: TaxJar / Avalara（国際販売の税計算自動化）

### 14.5 検討すべき追加技術（要件次第）
- フロント分離（ヘッドレス）を強く望む場合: Headless CMS（Contentful / Sanity） + Next.js
- 高速全文検索が最優先なら Algolia を採用（有料だが速度/機能優位）
- フルマネージドのワークフローを好むなら: Supabase + Vercel の組合せで最小構成運用可能

### 14.6 受け入れ基準（技術面）
- 開発環境: `npm run dev` でローカル起動可能かつ型チェックエラーがゼロ
- CI: プルリクエストでLint/Unit/E2Eが通過すること
- 本番デプロイ: CanaryまたはBlue-Greenでロールアウトでき、障害時に自動ロールバックが動作すること

---

(注) 上記を `doc/ECSiteSpec.md` に追記しました。具体的な導入候補（例えば Tailwind vs CSS Modules、Meilisearch vs Algolia など）について詳細比較が必要なら次に実施します。

---

（レビュー用メモ）この文書は初期要件一覧です。優先度や運用フローの詳細、画面仕様は次フェーズで詰めてください。

## 付録D: 画面ごとの詳細ワイヤー（文章版）

以下は主要画面について、要素・レイアウト・動作・受け入れ基準を記載した文章版ワイヤーです。まずはモバイル優先で記載し、デスクトップ差分を補足します。

### D.1 トップページ
- 目的: ブランド訴求と導線（カテゴリ/コレクション/キャンペーン）への誘導
- レイアウト（モバイル）:
	- ヘッダー: ハンバーガー（カテゴリ）、ロゴ（中央）、検索アイコン、カートアイコン、アカウントアイコン
	- ヒーロセクション: フル幅スライダー（CTAボタン）、アクセシブルな画像代替テキスト
	- コレクションリンク: グリッドまたはカード（画像＋ラベル）
	- 注目商品カルーセル: 横スワイプ可能、タップで商品ページへ
	- フッター: サイトマップ、カスタマーサポートリンク、SNS
- キー動作: スワイプでカルーセル移動、遅延画像読み込み
- 受け入れ基準: ファーストビューにCTAがあり、ヒーロから目的ページへ2タップ以内で遷移できること

### D.2 カテゴリ一覧ページ
- 目的: 絞り込みと商品ブラウズの効率化
- レイアウト（モバイル）:
	- スタンディング検索バー（常時表示またはスクロールで固定）
 	- フィルタドロワー: サイズ/カラー/価格/在庫（複数選択可）
 	- 商品グリッド: 2列、商品カードに価格・バッジ（SALE/NEW）表示
- キー動作: フィルタ適用は即時かつ非同期更新（ローディングインジケータ表示）、無制限スクロールまたはページネーションは選択可能
- 受け入れ基準: フィルタ適用後の結果表示が2秒以内、絞り込み条件がURLパラメータで共有可能

### D.3 商品詳細ページ（PDP）
- 目的: 購入意思決定を支援し、バリエーション選択を容易にする
- レイアウト（モバイル）:
	- 画像ギャラリー（ピンチズーム、スワイプ）
	- タイトル、ブランド、価格（割引ラベル）
	- バリエーション選択（サイズ/カラー）: 選択不可のオプションは非活性表示とツールチップで説明
	- 在庫表示（在庫あり/残りわずか/入荷予定）
	- サイズガイドリンク（モーダルで表示）
	- 配送の概算（郵便番号入力で変化）
	- CTA: カートに追加（フローティングする設計を推奨）
 	- 関連商品、コーデ提案
- キー動作: バリエーション選択で価格や在庫が即時更新、画像はバリアントに紐づく切替
- 受け入れ基準: 主要バリエーション選択→カート追加までが3ステップ以内で完了

### D.4 カートページ
- 目的: 注文確定前の最終確認とコンバージョン促進
- レイアウト（モバイル）:
	- 商品一覧（画像、タイトル、バリエーション、数量、小計）
	- クーポン入力欄、送料見積り（郵便番号入力）
	- 小計/税/送料の明細、合計（固定フッターに合計と「チェックアウトへ」ボタン）
	- 推奨商品（クロセル）を控えめに表示
- キー動作: 数量変更は即時計算（楽に戻せるUndo UX）、在庫不足時は代替提案
- 受け入れ基準: 合計金額と適用割引が明示されていること、チェックアウトボタンは常に表示されること

### D.5 チェックアウト（多段ステップ）
- 目的: 支払い完了までの摩擦を最小化
- ステップ: 1) 配送先 2) 配送方法 3) 支払い 4) 確認
- レイアウト要点（モバイル）:
	- ステップインジケータ（現在位置を明示）
	- 住所入力補助（オートコンプリート、住所帳の呼び出し）
	- 配送方法はコストと到着目安を明示
	- 支払いは外部決済・カードトークン入力をサポート
	- 注文確認で必ず最終金額（税・送料・割引）を表示
- キー動作: バック操作でデータ保持、必要最小限の必須項目のみを要求（ゲスト）
- 受け入れ基準: E2Eテストでゲスト購入フローが成功すること、支払いプロバイダ統合で決済が確定できること

### D.6 マイページ（アカウント）
- 目的: 顧客の自己管理（注文確認、アドレス管理、サイズプロファイル）
- 主なセクション: 注文履歴（ステータスリンク）、アカウント情報、アドレス帳、ウィッシュリスト、クーポン履歴
- 受け入れ基準: 注文の詳細ページで追跡番号とステータスが確認できること

### D.7 管理画面（ダッシュボード / 商品エディタ）
- ダッシュボード: 速報（売上、注文数、在庫警告）、最近の注文件、アクティビティログ
- 商品エディタ: 基本情報、バリアント（SKU）管理、メディアアップロード（ドラッグ&ドロップ）、プレビュー
- バルク操作: CSVインポートとプレビュー、バリデーションエラーの返却
- 受け入れ基準: 商品登録後に公開状態でフロントに表示されるまでのパイプラインがCIでテストされること

### D.8 モバイル/デスクトップ差分（要点）
- ヘッダー: デスクトップはグローバルナビ＋検索、モバイルはハンバーガー／ドロワー
- 商品グリッド: デスクトップは4列/3列、モバイルは2列
- PDP: デスクトップはサイドにサムネイル／詳細、モバイルは縦積みでCTAを常設
- チェックアウト: デスクトップはサイドで注文要約、モバイルはステップ式フルスクリーン

### D.9 アクセシビリティ・国際化考慮（UI面）
- フォーカスの可視化、キーボード操作で到達可能な全インタラクション
- 画像alt、ラベル、リンクテキストは非依存テキストを使用
- 言語切替はユーザーコンテキストを保持して行う（通貨と配送条件の変化を明示）

---

（次）このセクションを `doc/ECSiteSpec.md` に追記しました。`id:9` のタスクを完了します。


## 12. 統合・運用要件（詳細）

以下は、外部連携と日常運用に関する要件・設計指針です。実装時は担当部署とSLAやデータ保管ポリシーを確定してください。

### 12.1 決済連携
- 対応: 主要クレジットカード、Apple Pay、Google Pay、PayPal、地域別のローカル決済（例: Konbini、Alipay）
- セキュリティ: カード情報は自社で保持せずトークン化（PCI準拠）
- リトライとエラー処理: 一時的失敗は指数バックオフで再試行、永続失敗は顧客通知とオペレーター通知
- 返金処理: 管理画面からの部分/全額返金をAPIで反映し、会計連携を行う
- ロギング: 決済イベントは不可変ログ（トランザクションID、ステータス、金額）を保存

### 12.2 配送・フルフィルメント連携
- 出荷API: 主要配送業者のAPIと連携してラベル生成・追跡番号取得を自動化
- フルフィルメントモデル: 自社倉庫 / 外部3PL / 店舗ピックアップをサポート
- 在庫引当: 注文確定時にSKU在庫を予約し、ピッキングリストを生成
- 追跡と通知: 配送ステータス更新を顧客へ自動通知（メール/SMS）
- 返品処理: 返品受付、倉庫受領、返金または再入庫処理のフローを定義

### 12.3 在庫・ERP/PIM連携
- 同期方式: 双方向同期（Webhooks/Batch）または片方向バッチ（夜間）を選定
- データ整合性: 最終更新タイムスタンプ、衝突解決ルール、リコンサイル手順
- スキーママッピング: PIM/ERPのフィールドと商品/バリアントスキーマのマッピング定義
- スループット制約: 大量商品更新時のレート制限とバッチ分割

### 12.4 税・価格計算エンジン
- 地域別税率、免税ルール、インボイス要件に対応する税エンジンを導入
- 価格ルール: プロモーション・割引の優先順位と適用順序を明確化

### 12.5 イベントとWebhooks
- 主要イベント: 注文作成、支払い完了、出荷、返品、在庫閾値アラート
- 配信保証: 少なくとも1回（at-least-once）配信、冪等性キーで重複処理回避
- DLQ/再試行: 配信失敗はデッドレターキューに保存して再試行フローを用意

### 12.6 ログ・分析・データパイプライン
- 分析イベント: 購入ファネル、カート放棄、商品閲覧、キャンペーン効果をトラッキング
- ETL: 週次/日次でデータウェアハウス（BigQuery/Redshift等）に取り込み、BIで分析
- 個人情報の扱い: PIIはマスキング/ハッシュ化して解析用に保存

### 12.7 CI/CD・デプロイメント
- ブランチ戦略: trunk-based development 推奨、プルリクエストで自動テスト
- パイプライン: Lint → Unit → Integration → E2E（ステージング）→ Canary/Blue-Green デプロイ
- ロールバック: 自動ロールバック条件（エラー率閾値）と手順を用意

### 12.8 環境と設定管理
- 環境区分: 開発・検証・ステージング・本番を分離
- 機密情報: 環境別のSecrets管理（KMS/Secrets Manager）
- コンフィグの変更履歴: Feature flag と設定のバージョン管理

### 12.9 監視・アラート・運用フロー
- 監視対象: アプリヘルス、キュー長、決済失敗率、注文処理時間、在庫同期エラー
- アラートポリシー: SLOに紐づくアラート、夜間/休日のエスカレーションルール
- ランブック: インシデント時のステップバイステップ手順（優先度別）

### 12.10 ベンダーSLA・契約管理
- 決済・配送・CDN等主要ベンダーのSLAを明確化し、障害時の責任と補償を定義
- ベンダー障害時の代替手段（フェイルオーバー）を設計

### 12.11 テスト戦略（統合・運用面）
- モック/スタブ: 外部APIを模擬するテスト環境を提供
- E2E: 支払い・配送含むE2EテストをCIで定期実行
- 負荷: ピーク想定の負荷試験と性能限界のテスト

### 12.12 運用チェックリスト（日次/週次）
- 日次: 注文/決済エラー確認、未処理注文の有無、在庫警告
- 週次: バッチ成功確認、バックアップ正常性、セキュリティパッチ適用状況
- 月次: SLAsのレビュー、コスト・使用状況レビュー

### 12.13 受け入れ基準（統合・運用）
- 外部連携: 決済・配送の主要フローがステージングで成功すること
- 障害対応: 重大インシデントに対する初動対応が定義されたSLA内で行われること
- データ整合性: 日次の在庫差分が許容閾値内であること（例: 0.5%未満）


## 付録A: 機能要件の詳細化（主要）

### A.1 商品データ（推奨スキーマ）
- `product`: id, title, slug, description, vendor, collection, tags, published
- `variant`(SKU): id, product_id, sku, price, compare_at_price, currency, size, color, stock, weight
- `media`: id, product_id, url, type (image/video), alt_text, position
- `attributes`: 素材、原産国、ケア情報、フィットタイプ

### A.2 注文データ（推奨フィールド）
- `order`: id, user_id (nullable), order_number, status, total_amount, currency, tax, shipping_cost, payment_status, placed_at
- `order_item`: id, order_id, variant_id, quantity, unit_price
- `shipping`: method, carrier, tracking_number, cost, address

### A.3 顧客データ
- `customer`: id, email, name, phone, default_address_id, addresses[], created_at, last_order_at, tags
- 顧客の好み（サイズ、フィット、好みの色）を保持してパーソナライズに利用

### A.4 主要API（例）
- GET `/api/products` — カタログ取得（クエリ: q, category, price_min, price_max, size, color, sort, page）
- GET `/api/products/:slug` — 商品詳細（在庫・バリエーション含む）
- POST `/api/cart` — カート追加
- PATCH `/api/cart` — カート更新（数量・バリアント変更）
- POST `/api/checkout` — 注文作成（支払い、配送情報連携）
- GET `/api/orders/:id` — 注文ステータス取得

### A.5 バリデーションと業務ルール
- SKU単位で在庫チェックを行い、注文確定時に在庫を確保（予約）する
- 在庫不足時はユーザー向けに代替サイズ/カラーを提案
- クーポンは適用条件（対象商品/カテゴリー、最小購入金額、利用回数制限）を厳密に検証

## 付録B: 主要画面フロー（文章版ワイヤー）

### B.1 トップページ
- ヒーローバナー（新コレクション）、プロモーションバナー
- カテゴリリンク、注目商品（カルーセル）、新着・人気セクション

### B.2 カテゴリ一覧
 - 絞り込みサイドバー（モバイルはドロワー）: サイズ、カラー、価格帯
 - 商品カード: 画像、商品名、価格、バッジ（新着/セール）

### B.3 商品詳細ページ
- メイン画像ギャラリー、サムネイル、ズーム
- 選択部（サイズ/カラー/数量）、在庫表示、サイズガイドリンク
- 価格・クーポン欄、配送情報（概算）
 - 関連商品・コーデ表示
- CTA: カートに追加、ウィッシュリスト、シェア

### B.4 カート
- 商品リスト（サムネイル・バリエーション・数量調整）
- 小計、適用クーポン、送料見積もり入力（郵便番号）
- ログイン促進とゲストチェックアウトを明示
- CTA: チェックアウトへ

### B.5 チェックアウト（ステップ式推奨）
1. 配送先情報（住所入力、住所帳から選択）
2. 配送方法（料金・到着目安を明示）
3. 支払い（決済方法選択、カード入力または外部決済）
4. 注文確認（注文要約、税・送料、利用規約同意）

### B.6 マイページ
- 注文履歴、注文詳細、返品申請、アカウント設定、サイズプロファイル

## 付録C: 運用・監視の推奨チェックリスト
- 重要ジョブ（注文処理、在庫同期、メール配信）の監視と再試行ポリシー
- 決済失敗や配送エラーに対するアラートと担当者エスカレーション
- 週次レポート: 注文数、売上、決済失敗率、在庫警告

(次) `doc/ECSiteSpec.md` に上記を追記しました。必要なら各セクションをさらに画面仕様・APIドキュメントに展開します。
